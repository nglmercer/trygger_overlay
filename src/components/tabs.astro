---
// src/components/Tabs.astro
import { tabs, TabClassnames, type TabName } from "src/config/tabs";

const STORAGE_KEY = "trygger_activeTab";

// Intentar obtener el tab guardado en localStorage, si no existe usar el primero
const getInitialTab = () => {
  if (typeof window !== "undefined") {
    const savedTab = localStorage.getItem(STORAGE_KEY);
    if (savedTab && tabs.some(t => t.label === savedTab)) {
      return savedTab;
    }
  }
  return tabs.find(t => t.active)?.label || tabs[0].label;
};

const initialActiveTab = getInitialTab();
---

<div class="w-full h-16 flex bg-transparent px-3">
  <div class="flex w-full h-16 items-center">
    <div 
      id="tabs-container" 
      class={`
        flex flex-1 bg-gray-800 relative
        md:overflow-hidden md:touch-none
        max-md:overflow-x-auto max-md:touch-pan-x max-md:scrollbar-thin max-md:scrollbar-track-gray-700 max-md:scrollbar-thumb-gray-600
      `}
      data-storage-key={STORAGE_KEY}
    >
      <div 
        id="TabIndicator" 
        class="absolute bottom-0 left-0 h-0.5 bg-[rgb(110,121,255)] transition-all duration-300 ease-in-out"
      ></div>
      
      {tabs.map(tab => (
        <button
          class={`${TabClassnames.base} ${
            tab.label === initialActiveTab 
              ? TabClassnames.active 
              : TabClassnames.inactive
          } min-w-[120px]`}
          data-tab-label={tab.label}
        >
          <b class={`mb-1 pointer-events-none ${tab.label === initialActiveTab ? "" : "opacity-70"}`}>
            {tab.label}
          </b>
          <span class="material-symbols-outlined text-2xl pointer-events-none">
            {tab.label === "Images" ? "image" :
             tab.label === "Videos" ? "movie" :
             tab.label === "Sounds" ? "volume_up" :
             "drafts"}
          </span>
        </button>
      ))}
    </div>
  </div>
</div>

<script>
  import { emitter } from "@utils/Emitter";
  import { TabClassnames } from "src/config/tabs";

  const STORAGE_KEY = "trygger_activeTab";

  function initializeTabsAndIndicator() {
    const tabsContainer = document.getElementById('tabs-container') as HTMLElement;
    const indicator = document.getElementById('TabIndicator') as HTMLElement;
    
    if (!tabsContainer || !indicator) {
        console.error("No se encontraron los elementos de las pestañas o el indicador.");
        return;
    }

    const activeClasses = TabClassnames.active.split(' ');
    const inactiveClasses = TabClassnames.inactive.split(' ');

    /**
     * Mueve el indicador a la posición del botón especificado
     * @param {HTMLElement} targetButton - El botón de la pestaña al que debe moverse el indicador.
     */
    function moveIndicator(targetButton: HTMLElement | null) {
      if (!targetButton) return;
      
      const targetWidth = targetButton.offsetWidth;
      const targetOffsetLeft = targetButton.offsetLeft;
      indicator.style.width = `${targetWidth}px`;
      indicator.style.transform = `translateX(${targetOffsetLeft}px)`;
    }

    /**
     * Actualiza la clase activa del tab
     * @param {string} tabLabel - Label del tab activo
     */
    function setActiveTab(tabLabel: string) {
      // Guardar en localStorage
      localStorage.setItem(STORAGE_KEY, tabLabel);
      
      // Emitir evento para otros componentes
      emitter.emit('tab:changed', tabLabel);

      const allButtons = tabsContainer.querySelectorAll('button');
      allButtons.forEach(button => {
        button.classList.remove(...activeClasses);
        button.classList.add(...inactiveClasses);
        const textElement = button.querySelector('b');
        if (textElement) textElement.classList.add('opacity-70');
      });

      const activeButton = tabsContainer.querySelector(`[data-tab-label="${tabLabel}"]`) as HTMLElement;
      if (activeButton) {
        activeButton.classList.remove(...inactiveClasses);
        activeButton.classList.add(...activeClasses);
        const clickedTextElement = activeButton.querySelector('b');
        if (clickedTextElement) clickedTextElement.classList.remove('opacity-70');
        moveIndicator(activeButton);
      }
    }

    // --- Manejo de eventos ---

    tabsContainer.addEventListener('click', (event) => {
      const clickedButton = (event.target as HTMLElement).closest('button');
      if (!clickedButton) return;

      const tabLabel = clickedButton.dataset.tabLabel;
      if (!tabLabel) return;

      setActiveTab(tabLabel);
    });

    // Mover el indicador en la carga inicial
    const savedTab = localStorage.getItem(STORAGE_KEY);
    const initialActiveButton = tabsContainer.querySelector(`[data-tab-label="${savedTab}"]`) as HTMLElement;
    if (initialActiveButton) {
      moveIndicator(initialActiveButton);
    } else {
      // Fallback si no hay tab guardado
      const fallbackButton = tabsContainer.querySelector(`.${TabClassnames.active.split(' ').find(c => c.includes('font-bold'))}`) as HTMLElement;
      if (fallbackButton) moveIndicator(fallbackButton);
    }

    // Mover el indicador si la ventana cambia de tamaño
    window.addEventListener('resize', () => {
        const currentActiveButton = tabsContainer.querySelector(`.${TabClassnames.active.split(' ').find(c => c.includes('font-bold'))}`) as HTMLElement;
        moveIndicator(currentActiveButton);
    });

    // Escuchar cambios externos de tab (desde otros componentes)
    emitter.on('tab:change', (tabName: string) => {
      setActiveTab(tabName);
    });
  }

  initializeTabsAndIndicator();
</script>
